<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SafeBid - Auction detail</title>
  </head>
  <body>
    <p><a href="/buyer/auctions/">← Back to auctions</a></p>

    <h1>Auction detail</h1>

    <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
      <div><strong>Auction ID:</strong> {{ item_id }}</div>

      <label>
        Buyer identity (demo):
        <select id="buyerSelect">
          <option value="">-- select buyer --</option>
          {% for b in buyers %}
            <option value="{{ b.id }}">{{ b.username }}</option>
          {% endfor %}
        </select>
      </label>

      <span style="margin-left: 14px;"></span>

      <label>
        Session id (MPST demo):
        <input id="sessionId" type="text" value="demo1" />
      </label>

      <span id="pollStatus" style="margin-left: 12px; color:#555;"></span>
    </div>

    <div id="auctionBox" style="border:1px solid #ccc; padding:12px; margin:10px 0;">
      Loading auction...
    </div>

    <h2>Place a bid</h2>
    <div style="border:1px solid #ccc; padding:12px; margin:10px 0;">
      <label>
        Amount:
        <input id="bidAmount" type="number" step="0.01" min="0" />
      </label>
      <button id="placeBidBtn" type="button">Place bid</button>
      <p id="bidResult" style="margin-top:10px;"></p>
      <p style="color:#666; font-size:0.9em; margin-top:10px;">
        LIVE: auto-accepts only if amount &gt; current_price and you're not already highest bidder.<br/>
        COMING_SOON: bid becomes PENDING until seller confirms/rejects from Seller Dashboard.
      </p>
    </div>

    <h2>Recent bids</h2>
    <div id="bidsBox">Loading...</div>

    <script>
      const buyerSelect = document.getElementById("buyerSelect");
      const sessionIdInput = document.getElementById("sessionId");
      const pollStatus = document.getElementById("pollStatus");
      const auctionBox = document.getElementById("auctionBox");
      const bidsBox = document.getElementById("bidsBox");
      const bidAmountInput = document.getElementById("bidAmount");
      const placeBidBtn = document.getElementById("placeBidBtn");
      const bidResult = document.getElementById("bidResult");

      const itemId = Number("{{ item_id }}");

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function fmtTime(seconds) {
        const s = Math.max(0, Number(seconds || 0));
        const m = Math.floor(s / 60);
        const r = s % 60;
        return `${m}m ${r}s`;
      }

      function timeLabel(status, seconds) {
        if (status === "COMING_SOON") return `Starts in ${fmtTime(seconds)}`;
        if (status === "LIVE") return `Ends in ${fmtTime(seconds)}`;
        return `Ended`;
      }

      function setResult(msg, ok) {
        bidResult.textContent = msg;
        bidResult.style.color = ok ? "green" : "red";
      }

      function applyBuyerFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const buyerId = params.get("buyer_id");
        if (buyerId) buyerSelect.value = buyerId;
      }

      async function fetchState() {
        try {
          pollStatus.textContent = "Fetching...";
          const res = await fetch(`/api/auction/${itemId}/state/`);
          const data = await res.json();

          if (!res.ok) {
            auctionBox.innerHTML = `<p style="color:red;">${escapeHtml(data.error || "Failed")}</p>`;
            bidsBox.innerHTML = "";
            pollStatus.textContent = "Error";
            return;
          }

          const it = data.item;

          auctionBox.innerHTML = `
            <div><strong>${escapeHtml(it.name)}</strong></div>
            <div style="margin-top:6px;">${escapeHtml(it.description || "")}</div>
            <div style="margin-top:10px;">
              Seller: <strong>${escapeHtml(it.seller)}</strong><br/>
              Status: <strong>${it.status}</strong><br/>
              Current price: <strong>${it.current_price}</strong><br/>
              Highest bidder: ${it.highest_bidder ? "<strong>" + escapeHtml(it.highest_bidder) + "</strong>" : "-"}<br/>
              ${timeLabel(it.status, it.time_remaining_seconds)}
            </div>
          `;

          const bids = data.recent_bids || [];
          if (bids.length === 0) {
            bidsBox.innerHTML = `<p style="color:#666;">No bids yet.</p>`;
          } else {
            let html = `<ul>`;
            for (const b of bids) {
              html += `<li>
                #${b.id} — buyer: <strong>${escapeHtml(b.buyer)}</strong>, amount: <strong>${b.amount}</strong>,
                status: <strong>${b.status}</strong>
              </li>`;
            }
            html += `</ul>`;
            bidsBox.innerHTML = html;
          }

          pollStatus.textContent = "Updated " + new Date().toLocaleTimeString();
        } catch (e) {
          pollStatus.textContent = "Network error";
        }
      }

      async function placeBid() {
        const buyerId = buyerSelect.value;
        if (!buyerId) {
          setResult("Select a buyer first.", false);
          return;
        }

        const amountStr = bidAmountInput.value;
        if (!amountStr) {
          setResult("Enter a bid amount.", false);
          return;
        }

        const amount = Number(amountStr);
        if (!Number.isFinite(amount) || amount <= 0) {
          setResult("Bid amount must be a positive number.", false);
          return;
        }

        const sessionId = sessionIdInput.value || "demo1";

        try {
          placeBidBtn.disabled = true;
          setResult("Placing bid...", true);

          const res = await fetch("/bid/place/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              session_id: sessionId,
              buyer_id: Number(buyerId),
              item_id: Number(itemId),
              amount: amount,
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            const msg = data.error ? data.error : "Bid failed";
            const details = data.details ? ` (${data.details})` : "";
            setResult(msg + details, false);
            return;
          }

          // Show concise result
          if (data.status === "ACCEPTED") {
            setResult(`Accepted ✅ New current price: ${data.current_price}`, true);
          } else if (data.status === "PENDING_SELLER_DECISION") {
            setResult(`Pending seller decision ⏳ (bid #${data.bid_id})`, true);
          } else if (data.status === "REJECTED") {
            setResult(`Rejected ❌ ${data.reason || ""}`, false);
          } else {
            setResult(`Result: ${data.status}`, true);
          }

          // refresh immediately so UI feels "real-time"
          await fetchState();
        } catch (e) {
          setResult("Network error while placing bid.", false);
        } finally {
          placeBidBtn.disabled = false;
        }
      }

      placeBidBtn.addEventListener("click", placeBid);

      applyBuyerFromQuery();
      fetchState();
      setInterval(fetchState, 2000);
    </script>
  </body>
</html>
